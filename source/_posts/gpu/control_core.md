---
title: GPU control core
date: 2024-01-30 
tags: gpu
---
本篇是《通用图形处理器设计GPGPI编程模型与架构原理》的控制核心架构
<!--more-->
## 指令流水线
![Alt text](pic/gpgpuarch.png)
### 前段 取指译码 
- 依据pc值从指令缓存中取指，经过指令译码单元，存入指令缓冲，每个warp需要保存一个PC
### 中段 调度发射
- 解决数据相关，记分牌
- 分支管理，simt堆栈
- 寄存器文件和操作数收集器
### 后段 执行和写回
- 计算单元
- 访存单元


## 线程分支
### 谓词(predicate)寄存器
gpgpu架构普遍采用显式的谓词寄存器，谓词寄存器为每个执行通道配备1bit寄存器用来控制通道是否打开
### simt堆栈
根据每个线程的谓词寄存器可以形成线程束的活跃掩码信息
![](pic/gpgpusimt1.png)
- RPC：分支汇聚点（IPDOM）PC，一般由CFG（控制流图）分析得到
- NPC：该分支内需要执行的下一条指令PC
- TOS：栈顶指针

具体分析：
![](pic/gpgpusimt2.png)
> reference：
> https://zhuanlan.zhihu.com/p/593248814
> https://zhuanlan.zhihu.com/p/636979440


### 分支屏障
simt堆栈会存在一些问题，比如死锁：
![](pic/gpgpubarrier.png)



## 线程束调度
因为GPGPU切换线程的开销很小，因此可以通过大量线程束并发来隐藏访存时延，线程束的并发度由硬件资源决定
不同线程束的不同指令会交织执行，同一线程束的指令顺序执行
### 基本调度策略
就绪指令的基本条件
1. 指令已取到
2. 相关性解决
3. 执行单元可用

未就绪的原因：
1. pipeline busy 指令所需的功能单元忙
2. texture忙
3. constant缓存缺失
4. 指令缓存缺失
5. memory throttle，大量访存操作尚未完成
6. memory dependency
7. 线程等待同步
8. 数据相关 

调度策略
- 基本轮询，轮转
- 贪心策略，一直发射一个线程束的指令

## 数据相关
一般的数据相关有三种
- RAW写后读
- WAW写后写
- WAR读后写

后两种没有数据传递，由于采用相同的寄存器编号将不相关指令人为联系在一起，可以通过寄存器重命名消除
GPGPU中采用顺序执行，且GPGPU指令仍然需要多个周期完成，只可能发生两种相关
- RAW写后读
- WAW写后写

### 记分牌算法
### Tomasulo算法

### GPGPU中的记分牌

## 线程块的分配与调度